// Copyright 2023 - 2024 Matt Borland
// Copyright 2023 - 2024 Christopher Kormanyos
// Copyright 2025 - 2026 Justin Zhu
// Distributed under the Boost Software License, Version 1.0.
// https://www.boost.org/LICENSE_1_0.txt

#ifndef BOOST_DECIMAL_DETAIL_CMATH_IMPL_SQRT_TABLES_HPP
#define BOOST_DECIMAL_DETAIL_CMATH_IMPL_SQRT_TABLES_HPP

// ============================================================================
// Shared sqrt tables and lookup function (SoftFloat-style)
//
// Like SoftFloat's softfloat_approxRecipSqrt_1k0s / _1k1s, used by all
// decimal sqrt implementations (sqrt32, sqrt64, sqrt128).
//
// k0 = 1/sqrt at LEFT EDGE of bin, k1 = slope.
// r0 = k0 - k1 * eps (eps in [0,1) within bin).
// Range [1, 10), 128 bins, scale 10^16.
// ============================================================================

#ifndef BOOST_DECIMAL_BUILD_MODULE
#include <cstdint>
#endif

namespace boost {
namespace decimal {
namespace detail {
namespace sqrt_tables {

// k0[i] = 10^16 / sqrt(1 + i * step), step = 9/128.
static constexpr std::uint64_t approxRecipSqrt_1k0s[128] = {
    10000000000000000ULL, 9665953493282832ULL, 9363291775690446ULL, 9087389347953036ULL,
    8834522085987723ULL, 8601653289127525ULL, 8386278693775347ULL, 8186312161546413ULL,
    8000000000000000ULL, 7825855808712296ULL, 7662610281769211ULL, 7509172071422913ULL,
    7364596943186587ULL, 7228063223242010ULL, 7098852075328911ULL, 6976331523151158ULL,
    6859943405700353ULL, 6749192649753565ULL, 6643638388299197ULL, 6542886560876246ULL,
    6446583712203042ULL, 6354411766316301ULL, 6266083599903659ULL, 6181339274290046ULL,
    6099942813304187ULL, 6021679435959851ULL, 5946353169977331ULL, 5873784785714819ULL,
    5803810000880093ULL, 5736277915056598ULL, 5671049640066687ULL, 5607997097862253ULL,
    5547001962252291ULL, 5487954724560283ULL, 5430753866417046ULL, 5375305125467167ULL,
    5321520841901914ULL, 5269319375510274ULL, 5218624584427538ULL, 5169365358009908ULL,
    5121475197315839ULL, 5074891837564410ULL, 5029556907695452ULL, 4985415622798046ULL,
    4942416505721723ULL, 4900511134653510ULL, 4859653913846296ULL, 4819801865030224ULL,
    4780914437337574ULL, 4742953333830018ULL, 4705882352941176ULL, 4669667243342232ULL,
    4634275570907938ULL, 4599676596608552ULL, 4565841164282797ULL, 4532741597360588ULL,
    4500351603704096ULL, 4468646187823564ULL, 4437601569801833ULL, 4407195110329918ULL,
    4377405241316662ULL, 4348211401589152ULL, 4319593977248311ULL, 4291534246286561ULL,
    4264014327112208ULL, 4237017130659008ULL, 4210526315789474ULL, 4184526247727532ULL,
    4159001959280291ULL, 4133939114630414ULL, 4109323975500113ULL, 4085143369505322ULL,
    4061384660534476ULL, 4038035721000550ULL, 4015084905827964ULL, 3992521028047597ULL,
    3970333335883720ULL, 3948511491226272ULL, 3927045549390528ULL, 3905925940074192ULL,
    3885143449429056ULL, 3864689203170959ULL, 3844554650657702ULL, 3824731549870060ULL,
    3805211953235952ULL, 3785988194242408ULL, 3767052874784089ULL, 3748398853200974ULL,
    3730019232961255ULL, 3711907351948728ULL, 3694056772316882ULL, 3676461270874584ULL,
    3659114829970786ULL, 3642011628847884ULL, 3625146035435550ULL, 3608512598558758ULL,
    3592106040535498ULL, 3575921250141394ULL, 3559953275919878ULL, 3544197319818084ULL,
    3528648731129847ULL, 3513303000728470ULL, 3498155755573008ULL, 3483202753472865ULL,
    3468439878096480ULL, 3453863134210764ULL, 3439468643138782ULL, 3425252638423952ULL,
    3411211461689766ULL, 3397341558684686ULL, 3383639475502508ULL, 3370101854969077ULL,
    3356725433186756ULL, 3343507036228583ULL, 3330443576974506ULL, 3317532052082544ULL,
    3304769539088110ULL, 3292153193625162ULL, 3279680246763151ULL, 3267348002454124ULL,
    3255153835084638ULL, 3243095187127430ULL, 3231169566888078ULL, 3219374546342135ULL,
    3207707759058502ULL, 3196166898204968ULL, 3184749714632132ULL, 3173454015032077ULL
};

// k1[i] = k0[i] - k0[i+1] (slope); k1[127] = k1[126].
static constexpr std::uint64_t approxRecipSqrt_1k1s[128] = {
    334046506717168ULL, 302661717592386ULL, 275902427737410ULL, 252867261965313ULL,
    232868796860198ULL, 215374595352178ULL, 199966532228934ULL, 186312161546413ULL,
    174144191287704ULL, 163245526943085ULL, 153438210346298ULL, 144575128236326ULL,
    136533719944577ULL, 129211147913099ULL, 122520552177753ULL, 116388117450805ULL,
    110750755946788ULL, 105554261454368ULL, 100751827422951ULL,  96302848673204ULL,
     92171945886741ULL,  88328166412642ULL,  84744325613613ULL,  81396460985859ULL,
     78263377344336ULL,  75326265982520ULL,  72568384262512ULL,  69974784834726ULL,
     67532085823495ULL,  65228274989911ULL,  63052542204434ULL,  60995135609962ULL,
     59047237692008ULL,  57200858143237ULL,  55448740949879ULL,  53784283565253ULL,
     52201466391640ULL,  50694791082736ULL,  49259226417630ULL,  47890160694069ULL,
     46583359751429ULL,  45334929868958ULL,  44141284897406ULL,  42999117076323ULL,
     41905371068213ULL,  40857220807214ULL,  39852048816072ULL,  38887427692650ULL,
     37961103507556ULL,  37070980888842ULL,  36215109598944ULL,  35391672434294ULL,
     34598974299386ULL,  33835432325755ULL,  33099566922209ULL,  32389993656492ULL,
     31705415880532ULL,  31044618021731ULL,  30406459471915ULL,  29789869013256ULL,
     29193839727510ULL,  28617424340841ULL,  28059730961750ULL,  27519919174353ULL,
     26997196453200ULL,  26490814869534ULL,  26000068061942ULL,  25524288447241ULL,
     25062844649877ULL,  24615139130301ULL,  24180605994791ULL,  23758708970846ULL,
     23348939533926ULL,  22950815172586ULL,  22563877780367ULL,  22187692163877ULL,
     21821844657448ULL,  21465941835744ULL,  21119609316336ULL,  20782490645136ULL,
     20454246258097ULL,  20134552513257ULL,  19823100787642ULL,  19519596634108ULL,
     19223758993544ULL,  18935319458319ULL,  18654021583115ULL,  18379620239719ULL,
     18111881012527ULL,  17850579631846ULL,  17595501442298ULL,  17346440903798ULL,
     17103201122902ULL,  16865593412334ULL,  16633436876792ULL,  16406558023260ULL,
     16184790394104ULL,  15967974221516ULL,  15755956101794ULL,  15548588688237ULL,
     15345730401377ULL,  15147245155462ULL,  14953002100143ULL,  14762875376385ULL,
     14576743885716ULL,  14394491071982ULL,  14216004714830ULL,  14041176734186ULL,
     13869903005080ULL,  13702083182178ULL,  13537620533431ULL,  13376421782321ULL,
     13218396958173ULL,  13063459254077ULL,  12911524891962ULL,  12762512994434ULL,
     12616345462948ULL,  12472946862011ULL,  12332244309027ULL,  12194167369486ULL,
     12058647957208ULL,  11925620239352ULL,  11795020545943ULL,  11666787283633ULL,
     11540860853534ULL,  11417183572836ULL,  11295699600055ULL,  11295699600055ULL
};

constexpr int table_size = 128;
constexpr int table_scale = 16;  // values scaled by 10^16

// Wrapper for table lookup (like softfloat_approxRecipSqrt32_1).
// Returns r0 = k0[index] - k1[index] * eps.
template <typename T>
constexpr auto approx_recip_sqrt_1(int index, T eps) noexcept -> T
{
    if (index < 0) { index = 0; }
    if (index >= table_size) { index = table_size - 1; }
    T k0_val{static_cast<std::uint64_t>(approxRecipSqrt_1k0s[index]), -table_scale};
    T k1_val{static_cast<std::uint64_t>(approxRecipSqrt_1k1s[index]), -table_scale};
    return k0_val - k1_val * eps;
}

} // namespace sqrt_tables
} // namespace detail
} // namespace decimal
} // namespace boost

#endif // BOOST_DECIMAL_DETAIL_CMATH_IMPL_SQRT_TABLES_HPP
